WITH AllSessionsRaw AS (
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170201
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170202
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170203
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170204
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170205
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170206
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170207
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170208
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170209
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170210
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170211
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170212
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170213
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170214
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170215
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170216
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170217
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170218
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170219
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170220
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170221
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170222
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170223
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170224
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170225
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170226
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170227
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170228
),
AllSessions AS (
  SELECT "fullVisitorId", "visitStartTime", "totals":"transactions"::INTEGER AS "transactions", "device":"deviceCategory"::STRING AS "deviceType"
  FROM AllSessionsRaw
),
Transactions AS (
   SELECT "fullVisitorId", "visitStartTime", "deviceType",
          ROW_NUMBER() OVER (PARTITION BY "fullVisitorId" ORDER BY "visitStartTime") AS rn
   FROM AllSessions
   WHERE "transactions" > 0
),
FirstTransactions AS (
   SELECT "fullVisitorId", "visitStartTime" AS "firstTransactionTime", "deviceType"
   FROM Transactions
   WHERE rn = 1
),
FirstVisits AS (
   SELECT "fullVisitorId", MIN("visitStartTime") AS "firstVisitTimeInFeb"
   FROM AllSessions
   GROUP BY "fullVisitorId"
)
SELECT ft."fullVisitorId" AS "visitorId",
       DATEDIFF('day', TO_TIMESTAMP(fv."firstVisitTimeInFeb"), TO_TIMESTAMP(ft."firstTransactionTime")) AS "days_elapsed_since_first_visit",
       ft."deviceType"
FROM FirstTransactions ft
JOIN FirstVisits fv ON ft."fullVisitorId" = fv."fullVisitorId";