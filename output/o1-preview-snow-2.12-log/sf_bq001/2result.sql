WITH all_sessions AS (
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170201"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170202"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170203"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170204"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170205"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170206"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170207"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170208"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170209"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170210"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170211"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170212"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170213"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170214"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170215"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170216"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170217"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170218"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170219"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170220"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170221"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170222"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170223"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170224"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170225"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170226"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170227"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170228"
),
first_visits AS (
    SELECT "fullVisitorId", MIN("date") AS first_visit_date
    FROM all_sessions
    WHERE "date" >= '20170201' AND "date" <= '20170228'
    GROUP BY "fullVisitorId"
),
transactions AS (
    SELECT
        s."fullVisitorId",
        s."date" AS transaction_date,
        s."device":"deviceCategory"::STRING AS deviceType
    FROM all_sessions s,
    LATERAL FLATTEN(input => s."hits") f
    WHERE f.value:"transaction":"transactionId"::STRING IS NOT NULL
      AND s."date" >= '20170201' AND s."date" <= '20170228'
),
first_transactions AS (
    SELECT t1."fullVisitorId", t1.transaction_date, t1.deviceType
    FROM (
        SELECT "fullVisitorId", MIN(transaction_date) AS first_transaction_date
        FROM transactions
        GROUP BY "fullVisitorId"
    ) t0
    JOIN transactions t1 ON t0."fullVisitorId" = t1."fullVisitorId" AND t0.first_transaction_date = t1.transaction_date
),
result AS (
    SELECT fv."fullVisitorId",
           DATEDIFF('day', TO_DATE(fv.first_visit_date, 'YYYYMMDD'), TO_DATE(ft.transaction_date, 'YYYYMMDD')) AS days_elapsed_since_first_visit,
           ft.deviceType
    FROM first_visits fv
    JOIN first_transactions ft ON fv."fullVisitorId" = ft."fullVisitorId"
)
SELECT "fullVisitorId" AS visitorId, days_elapsed_since_first_visit, deviceType
FROM result;