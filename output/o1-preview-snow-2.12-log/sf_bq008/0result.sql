WITH all_sessions AS (
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170101"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170102"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170103"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170104"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170105"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170106"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170107"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170108"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170109"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170110"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170111"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170112"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170113"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170114"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170115"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170116"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170117"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170118"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170119"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170120"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170121"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170122"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170123"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170124"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170125"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170126"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170127"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170128"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170129"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170130"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170131"
),
all_hits AS (
  SELECT
    t."fullVisitorId",
    t."visitId",
    h.value:"hitNumber"::INTEGER AS "hitNumber",
    h.value:"page"::OBJECT:"pagePath"::STRING AS "pagePath",
    h.value:"time"::INTEGER AS "time",
    t."trafficSource"::OBJECT:"campaign"::STRING AS "campaign"
  FROM all_sessions t, LATERAL FLATTEN(input => t."hits") h
  WHERE t."date" BETWEEN '20170101' AND '20170131'
),
numbered_hits AS (
  SELECT
    "fullVisitorId",
    "visitId",
    "hitNumber",
    "pagePath",
    "time",
    "campaign",
    LEAD("pagePath") OVER (PARTITION BY "fullVisitorId", "visitId" ORDER BY "hitNumber") AS "next_pagePath",
    LEAD("time") OVER (PARTITION BY "fullVisitorId", "visitId" ORDER BY "hitNumber") AS "next_time"
  FROM all_hits
),
home_hits AS (
  SELECT
    *,
    ("next_time" - "time") / 1000 AS "duration_in_seconds"
  FROM numbered_hits
  WHERE "pagePath" LIKE '/home%'
    AND "campaign" ILIKE '%Data Share%'
    AND "next_pagePath" IS NOT NULL
    AND "next_time" IS NOT NULL
)
SELECT
  "next_pagePath" AS "Next_Page",
  CAST(MAX("duration_in_seconds") AS NUMBER(38,4)) AS "Max_Time_On_Home_Page"
FROM home_hits
GROUP BY "next_pagePath"
ORDER BY COUNT(*) DESC NULLS LAST
LIMIT 1;