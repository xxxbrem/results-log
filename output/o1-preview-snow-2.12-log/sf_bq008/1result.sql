WITH sessions AS (
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170101"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170104"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170105"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170106"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170107"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170108"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170109"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170110"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170111"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170112"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170113"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170114"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170116"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170117"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170118"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170119"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170120"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170121"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170122"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170123"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170124"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170125"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170126"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170127"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170128"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170129"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170130"
  UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170131"
),
campaign_sessions AS (
  SELECT
    t."fullVisitorId",
    t."visitId",
    t."hits"
  FROM sessions t
  WHERE t."trafficSource":"campaign"::STRING = 'Data Share Promo'
),
hits_data AS (
  SELECT
    s."fullVisitorId",
    s."visitId",
    h.value:"hitNumber"::INTEGER AS "hitNumber",
    h.value:"time"::INTEGER AS "hitTime",
    h.value:"page"::VARIANT:"pagePath"::STRING AS "pagePath"
  FROM campaign_sessions s,
  LATERAL FLATTEN(input => s."hits") h
),
home_hits AS (
  SELECT
    h.*,
    LEAD(h."pagePath") OVER (PARTITION BY h."fullVisitorId", h."visitId" ORDER BY h."hitNumber") AS "next_page",
    LEAD(h."hitTime") OVER (PARTITION BY h."fullVisitorId", h."visitId" ORDER BY h."hitNumber") AS "next_hitTime"
  FROM hits_data h
  WHERE h."pagePath" LIKE '/home%'
),
results AS (
  SELECT
    "next_page" AS "Next_Page",
    MAX( CAST( ( "next_hitTime" - "hitTime" ) / 1000 AS INTEGER ) ) AS "Max_Time_On_Home_Page",
    COUNT(*) AS "Count"
  FROM home_hits
  WHERE "next_page" IS NOT NULL AND "next_page" != '/home'
  GROUP BY "next_page"
)
SELECT "Next_Page", "Max_Time_On_Home_Page"
FROM results
ORDER BY "Count" DESC NULLS LAST
LIMIT 1;