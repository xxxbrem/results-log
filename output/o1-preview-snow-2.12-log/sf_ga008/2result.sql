WITH all_events AS (
    SELECT TO_DATE("EVENT_DATE", 'YYYYMMDD') AS "Date", "USER_PSEUDO_ID", "EVENT_NAME"
    FROM (
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201101"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201102"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201103"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201104"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201105"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201106"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201107"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201108"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201109"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201110"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201111"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201112"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201113"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201114"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201115"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201116"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201117"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201118"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201119"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201120"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201121"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201122"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201123"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201124"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201125"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201126"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201127"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201128"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201129"
        UNION ALL
        SELECT "EVENT_DATE", "USER_PSEUDO_ID", "EVENT_NAME"
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201130"
    )
),
purchasers AS (
    SELECT DISTINCT "USER_PSEUDO_ID"
    FROM all_events
    WHERE "EVENT_NAME" = 'purchase'
)
SELECT TO_VARCHAR(t."Date", 'YYYY-MM-DD') AS "Date",
       SUM(t."User_Page_Views") AS "Total_Page_Views",
       ROUND(AVG(t."User_Page_Views"), 4) AS "Average_Page_Views_per_User"
FROM (
    SELECT "Date", "USER_PSEUDO_ID", COUNT(*) AS "User_Page_Views"
    FROM all_events
    WHERE "EVENT_NAME" = 'page_view' AND "USER_PSEUDO_ID" IN (SELECT "USER_PSEUDO_ID" FROM purchasers)
    GROUP BY "Date", "USER_PSEUDO_ID"
) t
GROUP BY t."Date"
ORDER BY t."Date";