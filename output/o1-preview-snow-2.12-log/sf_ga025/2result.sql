WITH all_events AS (
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180901
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180902
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180903
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180904
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180905
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180906
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180907
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180908
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180909
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180910
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180911
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180912
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180913
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180914
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180915
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180916
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180917
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180918
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180919
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180920
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180921
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180922
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180923
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180924
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180925
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180926
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180927
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180928
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180929
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180930
),
first_open_users AS (
    SELECT "user_pseudo_id",
           MIN(TO_DATE(TO_TIMESTAMP("user_first_touch_timestamp" / 1000000))) AS first_open_date
    FROM all_events
    WHERE "event_name" = 'first_open'
    GROUP BY "user_pseudo_id"
    HAVING first_open_date BETWEEN '2018-09-01' AND '2018-09-30'
),
uninstalls AS (
    SELECT "user_pseudo_id",
           MIN(TO_DATE(TO_TIMESTAMP("event_timestamp" / 1000000))) AS uninstall_date
    FROM all_events
    WHERE "event_name" IN ('app_remove', 'app_uninstall')
    GROUP BY "user_pseudo_id"
),
users_uninstalled_within_7_days AS (
    SELECT f."user_pseudo_id",
           f.first_open_date,
           u.uninstall_date,
           DATEDIFF('day', f.first_open_date, u.uninstall_date) AS days_to_uninstall
    FROM first_open_users f
    JOIN uninstalls u ON f."user_pseudo_id" = u."user_pseudo_id"
    WHERE DATEDIFF('day', f.first_open_date, u.uninstall_date) <= 7
),
crashes AS (
    SELECT DISTINCT u."user_pseudo_id"
    FROM users_uninstalled_within_7_days u
    JOIN all_events e ON u."user_pseudo_id" = e."user_pseudo_id"
    WHERE e."event_name" = 'app_exception'
      AND TO_DATE(TO_TIMESTAMP(e."event_timestamp" / 1000000)) <= u.uninstall_date
)
SELECT
    ROUND(
        ((SELECT COUNT(DISTINCT c."user_pseudo_id") FROM crashes c) * 100.0) /
        (SELECT COUNT(DISTINCT u."user_pseudo_id") FROM users_uninstalled_within_7_days u), 4
    ) AS "Percentage_of_users_who_experienced_crash";