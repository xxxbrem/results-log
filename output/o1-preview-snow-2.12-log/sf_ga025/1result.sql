WITH all_events AS (
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180901
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180902
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180903
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180904
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180905
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180906
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180907
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180908
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180909
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180910
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180911
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180912
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180913
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180914
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180915
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180916
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180917
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180918
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180919
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180920
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180921
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180922
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180923
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180924
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180925
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180926
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180927
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180928
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180929
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180930
),
first_open_users AS (
    SELECT DISTINCT "user_pseudo_id",
        TO_DATE(TO_TIMESTAMP(MIN("user_first_touch_timestamp") / 1000000)) AS "first_touch_date"
    FROM all_events
    WHERE TO_DATE(TO_TIMESTAMP("user_first_touch_timestamp" / 1000000)) BETWEEN '2018-09-01' AND '2018-09-30'
    GROUP BY "user_pseudo_id"
),
uninstall_events AS (
    SELECT "user_pseudo_id",
        TO_DATE(TO_TIMESTAMP(MIN("event_timestamp") / 1000000)) AS "uninstall_date"
    FROM all_events
    WHERE "event_name" = 'app_remove'
    GROUP BY "user_pseudo_id"
),
uninstall_users AS (
    SELECT u."user_pseudo_id",
        u."first_touch_date",
        ue."uninstall_date",
        DATEDIFF('day', u."first_touch_date", ue."uninstall_date") AS "days_to_uninstall"
    FROM first_open_users u
    JOIN uninstall_events ue ON u."user_pseudo_id" = ue."user_pseudo_id"
    WHERE DATEDIFF('day', u."first_touch_date", ue."uninstall_date") <= 7
),
exception_events AS (
    SELECT "user_pseudo_id",
        TO_DATE(TO_TIMESTAMP(MIN("event_timestamp") / 1000000)) AS "exception_date"
    FROM all_events
    WHERE "event_name" = 'app_exception'
    GROUP BY "user_pseudo_id"
),
exception_uninstall_users AS (
    SELECT u."user_pseudo_id"
    FROM uninstall_users u
    JOIN exception_events e ON u."user_pseudo_id" = e."user_pseudo_id"
    WHERE e."exception_date" BETWEEN u."first_touch_date" AND u."uninstall_date"
)
SELECT ROUND(
    (
        (SELECT COUNT(DISTINCT "user_pseudo_id") FROM exception_uninstall_users)::FLOAT /
        NULLIF((SELECT COUNT(DISTINCT "user_pseudo_id") FROM uninstall_users), 0)
    ) * 100, 4
) AS "Percentage_of_users_who_experienced_crash";