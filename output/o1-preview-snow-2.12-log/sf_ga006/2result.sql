WITH all_events AS (
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201101"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201102"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201103"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201104"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201105"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201106"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201107"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201108"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201109"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201110"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201111"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201112"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201113"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201114"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201115"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201116"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201117"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201118"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201119"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201120"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201121"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201122"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201123"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201124"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201125"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201126"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201127"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201128"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201129"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201130"
),
purchases AS (
  SELECT
    t."USER_PSEUDO_ID",
    t."EVENT_TIMESTAMP",
    t."ECOMMERCE":"purchase_revenue_in_usd"::FLOAT AS "purchase_revenue_usd",
    MAX(
      CASE WHEN ep.value:"key"::STRING = 'ga_session_id' THEN
        COALESCE(
          ep.value:"value":"int_value"::STRING,
          ep.value:"value":"string_value"::STRING,
          ep.value:"value":"double_value"::STRING
        )
      END
    ) AS "ga_session_id"
  FROM all_events t,
    LATERAL FLATTEN(input => t."EVENT_PARAMS") ep
  WHERE t."EVENT_NAME" = 'purchase'
    AND t."ECOMMERCE":"purchase_revenue_in_usd" IS NOT NULL
  GROUP BY t."USER_PSEUDO_ID", t."EVENT_TIMESTAMP", t."ECOMMERCE":"purchase_revenue_in_usd"
),
user_session_revenue AS (
  SELECT
    "USER_PSEUDO_ID",
    "ga_session_id",
    SUM("purchase_revenue_usd") AS "session_revenue_usd"
  FROM purchases
  GROUP BY "USER_PSEUDO_ID", "ga_session_id"
),
users_with_multiple_sessions AS (
  SELECT
    "USER_PSEUDO_ID"
  FROM user_session_revenue
  GROUP BY "USER_PSEUDO_ID"
  HAVING COUNT(DISTINCT "ga_session_id") > 1
)
SELECT
  usr."USER_PSEUDO_ID",
  ROUND(AVG(usr_sess."session_revenue_usd"), 4) AS "average_purchase_revenue_usd_per_session"
FROM user_session_revenue usr_sess
INNER JOIN users_with_multiple_sessions usr
  ON usr_sess."USER_PSEUDO_ID" = usr."USER_PSEUDO_ID"
GROUP BY usr."USER_PSEUDO_ID";