WITH installs AS (
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180801` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180802` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180803` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180804` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180805` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180806` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180807` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180808` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180809` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180810` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180811` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180812` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180813` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180814` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180815` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180816` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180817` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180818` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180819` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180820` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180821` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180822` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180823` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180824` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180825` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180826` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180827` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180828` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180829` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180830` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180831` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180901` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180902` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180903` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180904` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180905` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180906` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180907` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180908` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180909` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180910` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180911` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180912` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180913` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180914` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180915` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180916` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180917` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180918` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180919` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180920` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180921` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180922` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180923` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180924` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180925` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180926` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180927` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180928` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180929` WHERE event_name = 'first_open' UNION ALL
  SELECT user_pseudo_id, user_first_touch_timestamp FROM `firebase-public-project.analytics_153293282.events_20180930` WHERE event_name = 'first_open'
),
installs_grouped AS (
  SELECT
    user_pseudo_id,
    MIN(user_first_touch_timestamp) AS install_timestamp
  FROM installs
  GROUP BY user_pseudo_id
),
events AS (
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180801` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180802` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180803` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180804` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180805` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180806` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180807` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180808` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180809` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180810` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180811` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180812` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180813` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180814` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180815` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180816` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180817` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180818` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180819` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180820` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180821` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180822` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180823` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180824` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180825` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180826` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180827` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180828` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180829` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180830` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180831` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180901` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180902` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180903` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180904` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180905` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180906` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180907` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180908` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180909` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180910` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180911` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180912` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180913` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180914` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180915` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180916` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180917` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180918` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180919` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180920` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180921` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180922` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180923` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180924` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180925` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180926` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180927` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180928` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180929` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20180930` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20181001` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20181002` UNION ALL
  SELECT user_pseudo_id, event_timestamp FROM `firebase-public-project.analytics_153293282.events_20181003`
),
user_last_events AS (
  SELECT
    i.user_pseudo_id,
    i.install_timestamp,
    MAX(e.event_timestamp) AS last_event_timestamp
  FROM installs_grouped i
  LEFT JOIN events e ON i.user_pseudo_id = e.user_pseudo_id
  GROUP BY i.user_pseudo_id, i.install_timestamp
),
user_days AS (
  SELECT
    user_pseudo_id,
    install_timestamp,
    last_event_timestamp,
    TIMESTAMP_DIFF(
      TIMESTAMP_MICROS(last_event_timestamp),
      TIMESTAMP_MICROS(install_timestamp),
      DAY
    ) AS days_since_install
  FROM user_last_events
),
users_active_after_7_days AS (
  SELECT user_pseudo_id
  FROM user_days
  WHERE days_since_install >= 7
),
total_installs AS (
  SELECT COUNT(DISTINCT user_pseudo_id) AS total_users
  FROM installs_grouped
),
active_users AS (
  SELECT COUNT(DISTINCT user_pseudo_id) AS active_users
  FROM users_active_after_7_days
)
SELECT
  ROUND((active_users.active_users / total_installs.total_users) * 100, 4) AS Percentage_of_users
FROM active_users, total_installs;