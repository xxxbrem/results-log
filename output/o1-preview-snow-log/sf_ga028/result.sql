WITH cohort AS (
    SELECT DISTINCT "user_pseudo_id"
    FROM (
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180702"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180703"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180704"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180705"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180706"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180707"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180708"
    ) t
    WHERE TO_TIMESTAMP("user_first_touch_timestamp" / 1e6) >= '2018-07-02 00:00:00'
      AND TO_TIMESTAMP("user_first_touch_timestamp" / 1e6) < '2018-07-09 00:00:00'
),
week0 AS (
    SELECT DISTINCT "user_pseudo_id"
    FROM (
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180702"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180703"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180704"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180705"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180706"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180707"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180708"
    ) t
    WHERE TO_TIMESTAMP("event_timestamp" / 1e6) >= '2018-07-02 00:00:00'
      AND TO_TIMESTAMP("event_timestamp" / 1e6) < '2018-07-09 00:00:00'
),
week1 AS (
    SELECT DISTINCT "user_pseudo_id"
    FROM (
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180709"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180710"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180711"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180712"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180713"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180714"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180715"
    ) t
    WHERE TO_TIMESTAMP("event_timestamp" / 1e6) >= '2018-07-09 00:00:00'
      AND TO_TIMESTAMP("event_timestamp" / 1e6) < '2018-07-16 00:00:00'
),
week2 AS (
    SELECT DISTINCT "user_pseudo_id"
    FROM (
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180716"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180717"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180718"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180719"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180720"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180721"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180722"
    ) t
    WHERE TO_TIMESTAMP("event_timestamp" / 1e6) >= '2018-07-16 00:00:00'
      AND TO_TIMESTAMP("event_timestamp" / 1e6) < '2018-07-23 00:00:00'
),
week3 AS (
    SELECT DISTINCT "user_pseudo_id"
    FROM (
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180723"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180724"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180725"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180726"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180727"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180728"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180729"
    ) t
    WHERE TO_TIMESTAMP("event_timestamp" / 1e6) >= '2018-07-23 00:00:00'
      AND TO_TIMESTAMP("event_timestamp" / 1e6) < '2018-07-30 00:00:00'
),
week4 AS (
    SELECT DISTINCT "user_pseudo_id"
    FROM (
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180730"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180731"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180801"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180802"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180803"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180804"
        UNION ALL
        SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180805"
    ) t
    WHERE TO_TIMESTAMP("event_timestamp" / 1e6) >= '2018-07-30 00:00:00'
      AND TO_TIMESTAMP("event_timestamp" / 1e6) < '2018-08-06 00:00:00'
)
SELECT '0' AS "Week",
       CAST((SELECT COUNT(*) FROM cohort) AS DECIMAL(10,4)) AS "Total_New_Users",
       CAST((SELECT COUNT(DISTINCT w0."user_pseudo_id") FROM week0 w0 JOIN cohort c ON w0."user_pseudo_id" = c."user_pseudo_id") AS DECIMAL(10,4)) AS "Retained_Users"
UNION ALL
SELECT '1' AS "Week",
       NULL AS "Total_New_Users",
       CAST((SELECT COUNT(DISTINCT w1."user_pseudo_id") FROM week1 w1 JOIN cohort c ON w1."user_pseudo_id" = c."user_pseudo_id") AS DECIMAL(10,4)) AS "Retained_Users"
UNION ALL
SELECT '2' AS "Week",
       NULL AS "Total_New_Users",
       CAST((SELECT COUNT(DISTINCT w2."user_pseudo_id") FROM week2 w2 JOIN cohort c ON w2."user_pseudo_id" = c."user_pseudo_id") AS DECIMAL(10,4)) AS "Retained_Users"
UNION ALL
SELECT '3' AS "Week",
       NULL AS "Total_New_Users",
       CAST((SELECT COUNT(DISTINCT w3."user_pseudo_id") FROM week3 w3 JOIN cohort c ON w3."user_pseudo_id" = c."user_pseudo_id") AS DECIMAL(10,4)) AS "Retained_Users"
UNION ALL
SELECT '4' AS "Week",
       NULL AS "Total_New_Users",
       CAST((SELECT COUNT(DISTINCT w4."user_pseudo_id") FROM week4 w4 JOIN cohort c ON w4."user_pseudo_id" = c."user_pseudo_id") AS DECIMAL(10,4)) AS "Retained_Users"
ORDER BY "Week";