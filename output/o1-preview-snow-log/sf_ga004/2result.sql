WITH "december_events" AS (
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201201"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201202"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201203"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201204"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201205"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201206"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201207"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201208"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201209"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201210"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201211"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201212"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201213"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201214"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201215"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201216"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201217"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201218"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201219"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201220"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201221"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201222"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201223"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201224"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201225"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201226"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201227"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201228"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201229"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201230"
    UNION ALL
    SELECT "USER_PSEUDO_ID", "EVENT_NAME"
    FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201231"
),
"user_summary" AS (
    SELECT
        "USER_PSEUDO_ID",
        SUM(CASE WHEN "EVENT_NAME" = 'page_view' THEN 1 ELSE 0 END) AS "page_view_count",
        MAX(CASE WHEN "EVENT_NAME" = 'purchase' THEN 1 ELSE 0 END) AS "is_purchaser"
    FROM "december_events"
    GROUP BY "USER_PSEUDO_ID"
)
SELECT
    ROUND(
        AVG(CASE WHEN "is_purchaser" = 1 THEN "page_view_count" END) -
        AVG(CASE WHEN "is_purchaser" = 0 THEN "page_view_count" END),
        4
    ) AS "average_difference_in_pageviews"
FROM "user_summary";