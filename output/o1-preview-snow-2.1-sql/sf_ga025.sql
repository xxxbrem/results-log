WITH events AS (
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180901"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180902"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180903"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180904"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180905"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180906"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180907"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180908"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180909"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180910"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180911"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180912"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180913"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180914"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180915"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180916"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180917"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180918"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180919"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180920"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180921"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180922"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180923"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180924"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180925"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180926"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180927"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180928"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180929"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20180930"
  UNION ALL
  -- Include events up to October 3rd to capture uninstalls within seven days
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20181001"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20181002"
  UNION ALL
  SELECT * FROM "FIREBASE"."ANALYTICS_153293282"."EVENTS_20181003"
),
first_opens AS (
  SELECT "user_pseudo_id", MIN("event_timestamp") AS "first_open_time"
  FROM events
  WHERE "event_name" = 'first_open' AND "event_date" BETWEEN '20180901' AND '20180930'
  GROUP BY "user_pseudo_id"
),
uninstalls AS (
  SELECT "user_pseudo_id", MIN("event_timestamp") AS "uninstall_time"
  FROM events
  WHERE "event_name" = 'app_remove'
  GROUP BY "user_pseudo_id"
),
users_within_seven_days AS (
  SELECT fo."user_pseudo_id", fo."first_open_time", un."uninstall_time"
  FROM first_opens fo
  JOIN uninstalls un ON fo."user_pseudo_id" = un."user_pseudo_id"
  WHERE un."uninstall_time" BETWEEN fo."first_open_time" AND fo."first_open_time" + 7 * 24 * 60 * 60 * 1000000
),
crashes AS (
  SELECT "user_pseudo_id", MIN("event_timestamp") AS "crash_time"
  FROM events
  WHERE "event_name" = 'app_exception'
  GROUP BY "user_pseudo_id"
)
SELECT
  ROUND(
    CASE
      WHEN COUNT(DISTINCT uw."user_pseudo_id") = 0 THEN 0
      ELSE (COUNT(DISTINCT c."user_pseudo_id") * 100.0) / COUNT(DISTINCT uw."user_pseudo_id")
    END,
    4
  ) AS "Percentage_of_users_who_experienced_crash"
FROM
  users_within_seven_days uw
LEFT JOIN
  crashes c ON uw."user_pseudo_id" = c."user_pseudo_id"
  AND c."crash_time" BETWEEN uw."first_open_time" AND uw."uninstall_time";