SELECT e."NAME" AS "Bank_Name",
       ROUND(((ts."TOTAL_DEPOSITS" - ts."ESTIMATED_INSURED_DEPOSITS") / ts."TOTAL_ASSETS") * 100, 4) AS "Percentage_of_Uninsured_Assets"
FROM "FINANCE__ECONOMICS"."CYBERSYN"."FINANCIAL_INSTITUTION_ENTITIES" e
JOIN (
    SELECT t."ID_RSSD",
           MAX(CASE WHEN t."VARIABLE" = 'ASSET' AND t."DATE" = '2022-12-31' THEN t."VALUE" END) AS "TOTAL_ASSETS",
           MAX(CASE WHEN t."VARIABLE" = 'DEP' AND t."DATE" = '2022-12-31' THEN t."VALUE" END) AS "TOTAL_DEPOSITS",
           MAX(CASE WHEN t."VARIABLE" = 'DEPINS' AND t."DATE" = '2022-12-31' THEN t."VALUE" END) AS "ESTIMATED_INSURED_DEPOSITS"
    FROM "FINANCE__ECONOMICS"."CYBERSYN"."FINANCIAL_INSTITUTION_TIMESERIES" t
    WHERE t."VARIABLE" IN ('ASSET', 'DEP', 'DEPINS')
      AND t."DATE" = '2022-12-31'
    GROUP BY t."ID_RSSD"
) ts ON e."ID_RSSD" = ts."ID_RSSD"
WHERE e."IS_ACTIVE" = TRUE
  AND ts."TOTAL_ASSETS" > 10000000000
  AND ts."TOTAL_DEPOSITS" IS NOT NULL
  AND ts."ESTIMATED_INSURED_DEPOSITS" IS NOT NULL
ORDER BY "Percentage_of_Uninsured_Assets" DESC NULLS LAST
LIMIT 10;