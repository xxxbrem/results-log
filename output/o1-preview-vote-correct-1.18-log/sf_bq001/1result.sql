WITH feb_sessions AS (
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170201"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170202"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170203"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170204"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170205"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170206"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170207"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170208"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170209"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170210"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170211"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170212"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170213"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170214"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170215"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170216"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170217"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170218"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170219"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170220"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170221"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170222"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170223"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170224"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170225"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170226"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170227"
    UNION ALL
    SELECT *
    FROM GA360.GOOGLE_ANALYTICS_SAMPLE."GA_SESSIONS_20170228"
),
first_visits AS (
    SELECT "fullVisitorId",
           MIN(TO_DATE("date", 'YYYYMMDD')) AS "first_visit_date"
    FROM feb_sessions
    GROUP BY "fullVisitorId"
),
transactions AS (
    SELECT *,
           TO_DATE("date", 'YYYYMMDD') AS "transaction_date",
           "device":"deviceCategory"::STRING AS "deviceCategory"
    FROM feb_sessions
    WHERE "totals":"transactions"::INTEGER >= 1
),
first_transactions AS (
    SELECT "fullVisitorId",
           "transaction_date",
           "deviceCategory",
           ROW_NUMBER() OVER (PARTITION BY "fullVisitorId" ORDER BY "transaction_date") AS "rn"
    FROM transactions
)
SELECT t."fullVisitorId",
       DATEDIFF('day', v."first_visit_date", t."transaction_date") AS "days_between_first_transaction_and_first_visit_in_Feb2017",
       t."deviceCategory"
FROM first_transactions t
JOIN first_visits v
ON t."fullVisitorId" = v."fullVisitorId"
WHERE t."rn" = 1;