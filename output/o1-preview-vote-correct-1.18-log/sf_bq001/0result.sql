WITH feb_sessions AS (
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170201"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170202"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170203"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170204"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170205"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170206"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170207"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170208"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170209"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170210"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170211"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170212"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170213"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170214"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170215"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170216"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170217"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170218"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170219"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170220"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170221"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170222"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170223"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170224"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170225"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170226"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170227"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170228"
),
transactions_in_feb AS (
  SELECT
    t."fullVisitorId",
    t."date",
    t."visitStartTime",
    t."device":deviceCategory::STRING AS "deviceCategory"
  FROM feb_sessions t
  WHERE (t."totals":transactions)::INTEGER > 0
),
FirstTransactionPerVisitor AS (
  SELECT
    t."fullVisitorId",
    t."date" AS "first_transaction_date",
    t."deviceCategory"
  FROM (
    SELECT
      t."fullVisitorId",
      t."date",
      t."visitStartTime",
      t."deviceCategory",
      ROW_NUMBER() OVER (
        PARTITION BY t."fullVisitorId"
        ORDER BY t."date", t."visitStartTime"
      ) AS rn
    FROM transactions_in_feb t
  ) t
  WHERE t.rn = 1
),
visits_in_feb AS (
  SELECT
    v."fullVisitorId",
    v."date"
  FROM feb_sessions v
),
FirstVisitPerVisitor AS (
  SELECT
    v."fullVisitorId",
    MIN(v."date") AS "first_visit_date"
  FROM visits_in_feb v
  GROUP BY v."fullVisitorId"
)
SELECT
  ft."fullVisitorId",
  DATEDIFF('day',
    TO_DATE(fv."first_visit_date", 'YYYYMMDD'),
    TO_DATE(ft."first_transaction_date", 'YYYYMMDD')
  ) AS "days_between_first_transaction_and_first_visit",
  ft."deviceCategory"
FROM FirstTransactionPerVisitor ft
JOIN FirstVisitPerVisitor fv
  ON ft."fullVisitorId" = fv."fullVisitorId";