WITH purchasers AS (
    SELECT DISTINCT "USER_PSEUDO_ID" FROM (
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201201" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201202" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201203" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201204" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201205" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201206" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201207" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201208" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201209" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201210" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201211" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201212" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201213" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201214" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201215" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201216" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201217" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201218" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201219" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201220" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201221" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201222" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201223" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201224" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201225" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201226" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201227" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201228" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201229" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201230" WHERE "EVENT_NAME" = 'purchase' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201231" WHERE "EVENT_NAME" = 'purchase'
    ) AS purchaser_data
),
pageviews AS (
    SELECT "USER_PSEUDO_ID", COUNT(*) AS "pageview_count" FROM (
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201201" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201202" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201203" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201204" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201205" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201206" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201207" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201208" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201209" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201210" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201211" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201212" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201213" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201214" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201215" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201216" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201217" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201218" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201219" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201220" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201221" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201222" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201223" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201224" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201225" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201226" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201227" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201228" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201229" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201230" WHERE "EVENT_NAME" = 'page_view' UNION ALL
        SELECT "USER_PSEUDO_ID" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201231" WHERE "EVENT_NAME" = 'page_view'
    ) AS pv_data
    GROUP BY "USER_PSEUDO_ID"
)
SELECT
    ROUND(
        AVG(CASE WHEN p."USER_PSEUDO_ID" IS NOT NULL THEN pageviews."pageview_count" END)
        - AVG(CASE WHEN p."USER_PSEUDO_ID" IS NULL THEN pageviews."pageview_count" END),
        4
    ) AS "average_pageviews_difference"
FROM pageviews
LEFT JOIN purchasers p ON pageviews."USER_PSEUDO_ID" = p."USER_PSEUDO_ID";