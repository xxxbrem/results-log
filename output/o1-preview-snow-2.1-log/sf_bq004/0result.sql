WITH july_sessions AS (
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170701
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170702
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170703
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170704
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170705
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170706
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170707
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170708
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170709
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170710
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170711
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170712
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170713
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170714
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170715
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170716
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170717
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170718
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170719
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170720
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170721
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170722
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170723
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170724
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170725
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170726
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170727
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170728
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170729
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170730
  UNION ALL
  SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170731
)
SELECT
  p.value:"v2ProductName"::STRING AS "Product_Name",
  COUNT(*) AS "Purchase_Count"
FROM july_sessions t,
LATERAL FLATTEN(input => t."hits") h,
LATERAL FLATTEN(input => h.value:"product") p
WHERE t."fullVisitorId" IN (
  SELECT DISTINCT t2."fullVisitorId"
  FROM july_sessions t2,
  LATERAL FLATTEN(input => t2."hits") h2,
  LATERAL FLATTEN(input => h2.value:"product") p2
  WHERE p2.value:"v2ProductName"::STRING ILIKE '%YouTube%'
)
AND p.value:"v2ProductName"::STRING NOT ILIKE '%YouTube%'
GROUP BY p.value:"v2ProductName"::STRING
ORDER BY "Purchase_Count" DESC NULLS LAST
LIMIT 1;