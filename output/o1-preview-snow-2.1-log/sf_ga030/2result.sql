WITH all_events AS (
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180702"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180703"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180704"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180705"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180706"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180707"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180708"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180709"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180710"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180711"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180712"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180713"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180714"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180715"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180716"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180717"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180718"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180719"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180720"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180721"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180722"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180723"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180724"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180725"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180726"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180727"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180728"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180729"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180730"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180731"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180801"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180802"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180803"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180804"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180805"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180806"
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180807"
),
user_first_week AS (
  SELECT
    "user_pseudo_id",
    TO_DATE(MIN("event_date"), 'YYYYMMDD') AS "first_event_date"
  FROM
    all_events
  GROUP BY
    "user_pseudo_id"
),
user_week_start AS (
  SELECT
    "user_pseudo_id",
    "first_event_date",
    DATEADD('day', 1 - DAYOFWEEKISO("first_event_date"), "first_event_date") AS "week_start_date"
  FROM
    user_first_week
  WHERE
    "first_event_date" >= '2018-07-02'
),
user_events AS (
  SELECT
    uw."user_pseudo_id",
    uw."week_start_date",
    TO_DATE(ae."event_date", 'YYYYMMDD') AS "event_date"
  FROM
    user_week_start uw
  INNER JOIN
    all_events ae
  ON
    uw."user_pseudo_id" = ae."user_pseudo_id"
),
user_active_next_4_weeks AS (
  SELECT DISTINCT
    ue."user_pseudo_id",
    ue."week_start_date"
  FROM
    user_events ue
  WHERE
    ue."event_date" > ue."week_start_date"
    AND ue."event_date" <= DATEADD('day', 28, ue."week_start_date")
)
SELECT
  result."week_start_date" AS "Week_Start_Date"
FROM (
  SELECT
    uw."week_start_date",
    COUNT(DISTINCT uw."user_pseudo_id") AS "total_users_in_week",
    COUNT(DISTINCT ua."user_pseudo_id") AS "active_users_next_4_weeks"
  FROM
    user_week_start uw
  LEFT JOIN
    user_active_next_4_weeks ua
  ON
    uw."user_pseudo_id" = ua."user_pseudo_id"
  GROUP BY
    uw."week_start_date"
  ORDER BY
    COUNT(DISTINCT ua."user_pseudo_id") DESC NULLS LAST
  LIMIT 1
) AS result;