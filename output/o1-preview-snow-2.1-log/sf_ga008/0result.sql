WITH all_events AS (
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201101"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201102"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201103"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201104"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201105"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201106"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201107"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201108"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201109"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201110"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201111"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201112"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201113"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201114"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201115"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201116"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201117"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201118"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201119"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201120"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201121"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201122"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201123"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201124"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201125"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201126"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201127"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201128"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201129"
  UNION ALL
  SELECT *
  FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201130"
),

buyers AS (
  SELECT DISTINCT "USER_PSEUDO_ID", "EVENT_DATE"
  FROM all_events
  WHERE "EVENT_NAME" = 'purchase'
),

buyer_page_views AS (
  SELECT pv."USER_PSEUDO_ID", pv."EVENT_DATE"
  FROM all_events pv
  INNER JOIN buyers b
    ON pv."USER_PSEUDO_ID" = b."USER_PSEUDO_ID"
    AND pv."EVENT_DATE" = b."EVENT_DATE"
  WHERE pv."EVENT_NAME" = 'page_view'
),

buyer_page_view_counts AS (
  SELECT
    "EVENT_DATE",
    "USER_PSEUDO_ID",
    COUNT(*) AS page_views
  FROM buyer_page_views
  GROUP BY "EVENT_DATE", "USER_PSEUDO_ID"
),

daily_metrics AS (
  SELECT
    "EVENT_DATE",
    ROUND(AVG(page_views), 4) AS "Average_Page_Views_per_Buyer",
    SUM(page_views) AS "Total_Page_Views_Among_Buyers"
  FROM buyer_page_view_counts
  GROUP BY "EVENT_DATE"
)

SELECT
  TO_DATE("EVENT_DATE", 'YYYYMMDD') AS "Date",
  "Average_Page_Views_per_Buyer",
  "Total_Page_Views_Among_Buyers"
FROM daily_metrics
ORDER BY "Date";