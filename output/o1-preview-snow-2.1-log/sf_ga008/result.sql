WITH buyers AS (
  SELECT DISTINCT TO_DATE("EVENT_DATE", 'YYYYMMDD') AS "Date", COALESCE("USER_ID", "USER_PSEUDO_ID") AS "BUYER_ID"
  FROM (
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201101"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201102"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201103"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201104"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201105"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201106"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201107"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201108"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201109"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201110"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201111"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201112"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201113"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201114"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201115"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201116"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201117"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201118"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201119"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201120"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201121"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201122"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201123"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201124"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201125"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201126"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201127"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201128"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201129"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201130"
  ) AS ALL_EVENTS
  WHERE "EVENT_NAME" = 'purchase'
    AND COALESCE("USER_ID", "USER_PSEUDO_ID") IS NOT NULL
),
page_views AS (
  SELECT TO_DATE("EVENT_DATE", 'YYYYMMDD') AS "Date", COALESCE("USER_ID", "USER_PSEUDO_ID") AS "USER_ID"
  FROM (
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201101"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201102"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201103"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201104"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201105"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201106"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201107"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201108"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201109"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201110"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201111"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201112"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201113"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201114"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201115"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201116"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201117"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201118"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201119"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201120"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201121"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201122"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201123"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201124"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201125"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201126"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201127"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201128"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201129"
    UNION ALL
    SELECT "EVENT_DATE", "USER_ID", "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201130"
  ) AS ALL_EVENTS
  WHERE "EVENT_NAME" = 'page_view'
    AND COALESCE("USER_ID", "USER_PSEUDO_ID") IS NOT NULL
)
SELECT 
  TO_CHAR(pv_counts."Date", 'YYYY-MM-DD') AS "Date",
  ROUND(AVG(pv_counts."PAGE_VIEWS_PER_BUYER"), 4) AS "Average_Page_Views_per_Buyer",
  SUM(pv_counts."PAGE_VIEWS_PER_BUYER") AS "Total_Page_Views_Among_Buyers"
FROM (
  SELECT 
    pv."Date", 
    pv."USER_ID" AS "BUYER_ID",
    COUNT(*) AS "PAGE_VIEWS_PER_BUYER"
  FROM page_views pv
  INNER JOIN buyers b
    ON pv."Date" = b."Date" AND pv."USER_ID" = b."BUYER_ID"
  GROUP BY pv."Date", pv."USER_ID"
) AS pv_counts
GROUP BY pv_counts."Date"
ORDER BY pv_counts."Date";