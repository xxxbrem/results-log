WITH sessions AS (
  SELECT
    t."USER_PSEUDO_ID",
    t."EVENT_TIMESTAMP",
    t."TRAFFIC_SOURCE",
    t."EVENT_DATE",
    CAST(ep.value:"value":"int_value" AS STRING) AS "SESSION_ID"
  FROM (
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201201"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201202"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201203"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201204"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201205"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201206"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201207"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201208"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201209"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201210"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201211"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201212"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201213"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201214"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201215"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201216"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201217"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201218"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201219"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201220"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201221"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201222"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201223"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201224"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201225"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201226"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201227"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201228"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201229"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201230"
    UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201231"
  ) t,
  LATERAL FLATTEN(input => t."EVENT_PARAMS") ep
  WHERE t."EVENT_NAME" = 'session_start' AND ep.value:"key"::STRING = 'ga_session_id'
)
SELECT
  CASE
    WHEN
      s."TRAFFIC_SOURCE":"medium"::STRING = 'organic' OR
      s."TRAFFIC_SOURCE":"source"::STRING IN ('baidu', 'bing', 'duckduckgo', 'ecosia', 'google', 'yahoo', 'yandex')
    THEN 'Organic Search'
    WHEN s."TRAFFIC_SOURCE":"medium"::STRING = 'referral' THEN 'Referral'
    WHEN s."TRAFFIC_SOURCE":"source"::STRING IN ('baidu', 'bing', 'duckduckgo', 'ecosia', 'google', 'yahoo', 'yandex') AND LOWER(s."TRAFFIC_SOURCE":"medium"::STRING) REGEXP '.*(cp.*|ppc|paid.*).*' THEN 'Paid Search'
    WHEN s."TRAFFIC_SOURCE":"medium"::STRING IN ('(not set)', '(none)') AND s."TRAFFIC_SOURCE":"source"::STRING = '(direct)' THEN 'Direct'
    ELSE 'Unassigned'
  END AS "Channel",
  COUNT(DISTINCT s."SESSION_ID") AS "Number_of_Sessions"
FROM sessions s
GROUP BY "Channel"
ORDER BY "Number_of_Sessions" DESC NULLS LAST;