SELECT
    CASE
        WHEN LOWER(COALESCE("source", '')) = '(direct)' AND LOWER(COALESCE("medium", '')) IN ('(not set)', '(none)', '') THEN 'Direct'
        WHEN LOWER("medium") = 'organic' OR LOWER("source") IN ('baidu', 'bing', 'duckduckgo', 'ecosia', 'google', 'yahoo', 'yandex') THEN 'Organic Search'
        WHEN LOWER("medium") = 'referral' THEN 'Referral'
        WHEN LOWER("medium") IN ('email', 'e-mail', 'e_mail', 'e mail') OR LOWER("source") IN ('email', 'e-mail', 'e_mail', 'e mail') THEN 'Email'
        WHEN LOWER("medium") IN ('cpc', 'ppc', 'paidsearch') THEN 'Paid Search'
        WHEN LOWER("medium") IN ('display', 'banner', 'expandable', 'interstitial', 'cpm') THEN 'Display'
        WHEN LOWER("medium") = 'affiliate' THEN 'Affiliates'
        WHEN LOWER("medium") = 'audio' THEN 'Audio'
        WHEN LOWER("medium") = 'sms' OR LOWER("source") = 'sms' THEN 'SMS'
        WHEN LOWER("medium") LIKE '%push' OR LOWER("medium") LIKE '%mobile%' OR LOWER("medium") LIKE '%notification%' THEN 'Mobile Push Notifications'
        ELSE 'Unassigned'
    END AS "Channel",
    COUNT(DISTINCT "session_id") AS "Number_of_Sessions"
FROM (
    SELECT
        CASE
            WHEN ep.value:"value":"string_value" IS NOT NULL THEN ep.value:"value":"string_value"::STRING
            WHEN ep.value:"value":"int_value" IS NOT NULL THEN CAST(ep.value:"value":"int_value"::STRING AS VARCHAR)
            ELSE NULL
        END AS "session_id",
        t."TRAFFIC_SOURCE":"medium"::STRING AS "medium",
        t."TRAFFIC_SOURCE":"source"::STRING AS "source"
    FROM (
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201201"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201202"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201203"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201204"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201205"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201206"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201207"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201208"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201209"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201210"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201211"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201212"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201213"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201214"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201215"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201216"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201217"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201218"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201219"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201220"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201221"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201222"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201223"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201224"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201225"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201226"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201227"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201228"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201229"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201230"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201231"
    ) t,
    LATERAL FLATTEN(input => t."EVENT_PARAMS") ep
    WHERE
        t."EVENT_NAME" = 'session_start'
        AND ep.value:"key"::STRING = 'ga_session_id'
)
WHERE "session_id" IS NOT NULL
GROUP BY "Channel"
ORDER BY "Number_of_Sessions" DESC NULLS LAST