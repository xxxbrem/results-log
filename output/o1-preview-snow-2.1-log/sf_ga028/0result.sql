WITH
events_week0 AS (
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180702
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180703
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180704
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180705
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180706
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180707
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180708
),
new_users AS (
  SELECT DISTINCT "user_pseudo_id"
  FROM events_week0
  WHERE "user_first_touch_timestamp" >= 1530489600000000 AND "user_first_touch_timestamp" < 1531094400000000
),
events_week1 AS (
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180709
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180710
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180711
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180712
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180713
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180714
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180715
),
events_week2 AS (
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180716
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180717
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180718
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180719
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180720
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180721
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180722
),
events_week3 AS (
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180723
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180724
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180725
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180726
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180727
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180728
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180729
),
events_week4 AS (
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180730
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180731
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180801
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180802
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180803
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180804
  UNION ALL
  SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180805
),
retention AS (
  SELECT 0 AS "Week", COUNT(DISTINCT n."user_pseudo_id") AS "Retained_Users"
  FROM new_users n
  JOIN events_week0 e0 ON n."user_pseudo_id" = e0."user_pseudo_id"
  UNION ALL
  SELECT 1 AS "Week", COUNT(DISTINCT n."user_pseudo_id") AS "Retained_Users"
  FROM new_users n
  JOIN events_week1 e1 ON n."user_pseudo_id" = e1."user_pseudo_id"
  UNION ALL
  SELECT 2 AS "Week", COUNT(DISTINCT n."user_pseudo_id") AS "Retained_Users"
  FROM new_users n
  JOIN events_week2 e2 ON n."user_pseudo_id" = e2."user_pseudo_id"
  UNION ALL
  SELECT 3 AS "Week", COUNT(DISTINCT n."user_pseudo_id") AS "Retained_Users"
  FROM new_users n
  JOIN events_week3 e3 ON n."user_pseudo_id" = e3."user_pseudo_id"
  UNION ALL
  SELECT 4 AS "Week", COUNT(DISTINCT n."user_pseudo_id") AS "Retained_Users"
  FROM new_users n
  JOIN events_week4 e4 ON n."user_pseudo_id" = e4."user_pseudo_id"
)
SELECT 
  retention."Week",
  (CASE WHEN retention."Week" = 0 THEN (SELECT COUNT(*) FROM new_users) ELSE NULL END) AS "Total_New_Users",
  retention."Retained_Users"
FROM retention
ORDER BY retention."Week";