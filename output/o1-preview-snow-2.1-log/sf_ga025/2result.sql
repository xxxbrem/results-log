WITH events_september AS (
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180901
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180902
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180903
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180904
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180905
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180906
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180907
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180908
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180909
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180910
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180911
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180912
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180913
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180914
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180915
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180916
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180917
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180918
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180919
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180920
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180921
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180922
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180923
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180924
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180925
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180926
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180927
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180928
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180929
    UNION ALL
    SELECT * FROM FIREBASE.ANALYTICS_153293282.EVENTS_20180930
),
first_open_events AS (
    SELECT "user_pseudo_id", MIN("event_timestamp") AS "first_open_timestamp"
    FROM events_september
    WHERE "event_name" = 'first_open'
    GROUP BY "user_pseudo_id"
),
app_remove_events AS (
    SELECT "user_pseudo_id", MIN("event_timestamp") AS "app_remove_timestamp"
    FROM events_september
    WHERE "event_name" = 'app_remove'
    GROUP BY "user_pseudo_id"
),
uninstalled_within_7_days AS (
    SELECT fo."user_pseudo_id", fo."first_open_timestamp", ar."app_remove_timestamp"
    FROM first_open_events fo
    JOIN app_remove_events ar ON fo."user_pseudo_id" = ar."user_pseudo_id"
    WHERE ar."app_remove_timestamp" <= fo."first_open_timestamp" + (7 * 24 * 60 * 60 * 1000000)
),
app_exception_events AS (
    SELECT "user_pseudo_id", "event_timestamp"
    FROM events_september
    WHERE "event_name" = 'app_exception'
),
users_with_crash AS (
    SELECT DISTINCT u."user_pseudo_id"
    FROM uninstalled_within_7_days u
    JOIN app_exception_events e ON u."user_pseudo_id" = e."user_pseudo_id"
    WHERE e."event_timestamp" BETWEEN u."first_open_timestamp" AND u."app_remove_timestamp"
)
SELECT
    ROUND(
        ((SELECT COUNT(DISTINCT "user_pseudo_id") FROM users_with_crash)::FLOAT /
         (SELECT COUNT(DISTINCT "user_pseudo_id") FROM uninstalled_within_7_days)) * 100,
        4
    ) AS "Percentage_of_users_who_experienced_crash"
;