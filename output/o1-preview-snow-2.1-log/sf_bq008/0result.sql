WITH sessions AS (
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170101"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170102"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170103"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170104"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170105"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170106"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170107"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170108"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170109"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170110"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170111"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170112"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170113"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170114"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170115"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170116"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170117"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170118"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170119"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170120"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170121"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170122"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170123"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170124"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170125"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170126"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170127"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170128"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170129"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170130"
    UNION ALL SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170131"
),
hits_data AS (
    SELECT
        t."fullVisitorId",
        t."visitId",
        h.value:"hitNumber"::INTEGER AS "hit_number",
        h.value:"type"::VARCHAR AS "hit_type",
        h.value:"time"::INTEGER AS "hit_time",
        h.value:"page":"pagePath"::VARCHAR AS "page_path",
        t."date"
    FROM sessions AS t,
         LATERAL FLATTEN(input => t."hits") AS h
    WHERE t."trafficSource":"campaign"::VARCHAR = 'Data Share Promo'
        AND h.value:"type"::VARCHAR = 'PAGE'
        AND t."date" BETWEEN '20170101' AND '20170131'
),
page_sequences AS (
    SELECT
        "fullVisitorId",
        "visitId",
        "hit_number",
        "page_path" AS "current_page",
        LEAD("page_path") OVER (
            PARTITION BY "fullVisitorId", "visitId"
            ORDER BY "hit_number"
        ) AS "next_page",
        (LEAD("hit_time") OVER (
            PARTITION BY "fullVisitorId", "visitId"
            ORDER BY "hit_number"
        ) - "hit_time") / 1000.0 AS "duration_seconds"
    FROM hits_data
)
SELECT
    "next_page" AS "Most_Common_Next_Page",
    ROUND(MAX("duration_seconds"), 4) AS "Maximum_Duration_Seconds"
FROM page_sequences
WHERE "current_page" LIKE '/home%'
  AND "next_page" IS NOT NULL
  AND "next_page" NOT LIKE '/home%'
GROUP BY "next_page"
ORDER BY COUNT(*) DESC NULLS LAST, "Most_Common_Next_Page"
LIMIT 1;