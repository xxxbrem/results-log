WITH all_events AS (
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201101"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201102"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201103"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201104"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201105"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201106"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201107"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201108"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201109"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201110"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201111"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201112"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201113"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201114"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201115"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201116"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201117"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201118"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201119"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201120"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201121"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201122"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201123"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201124"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201125"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201126"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201127"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201128"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201129"
  UNION ALL SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201130"
),
purchase_events AS (
  SELECT
    CAST(t."USER_PSEUDO_ID" AS VARCHAR) AS "User_ID",
    COALESCE(
      ep.value:"value":"int_value"::STRING,
      ep.value:"value":"string_value"::STRING,
      ep.value:"value":"double_value"::STRING
    ) AS "Session_ID",
    t."EVENT_VALUE_IN_USD" AS "Purchase_Value_USD"
  FROM
    all_events t,
    LATERAL FLATTEN(input => t."EVENT_PARAMS") ep
  WHERE
    ep.value:"key"::STRING = 'ga_session_id'
    AND t."EVENT_NAME" = 'purchase'
    AND t."EVENT_VALUE_IN_USD" IS NOT NULL
),
avg_purchase_per_session AS (
  SELECT
    "User_ID",
    "Session_ID",
    ROUND(AVG("Purchase_Value_USD"), 4) AS "Average_Purchase_Value_USD"
  FROM
    purchase_events
  GROUP BY
    "User_ID",
    "Session_ID"
),
user_session_counts AS (
  SELECT
    "User_ID",
    COUNT(DISTINCT "Session_ID") AS "session_count"
  FROM
    avg_purchase_per_session
  GROUP BY
    "User_ID"
)
SELECT
  a."User_ID",
  a."Session_ID",
  a."Average_Purchase_Value_USD"
FROM
  avg_purchase_per_session a
JOIN
  user_session_counts u
ON
  a."User_ID" = u."User_ID"
WHERE
  u."session_count" > 1
ORDER BY
  a."User_ID",
  a."Session_ID";