WITH data AS (
    SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM (
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180709" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180710" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180711" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180712" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180713" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180714" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180715" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180716" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180717" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180718" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180719" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180720" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180721" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180722" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180723" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180724" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180725" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180726" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180727" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180728" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180729" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180730" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180731" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180801" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180802" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180803" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180804" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180805" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180806" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180807" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180808" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180809" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180810" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180811" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180812" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180813" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180814" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180815" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180816" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180817" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180818" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180819" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180820" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180821" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180822" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180823" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180824" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180825" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180826" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180827" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180828" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180829" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180830" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180831" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180901" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180902" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180903" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180904" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180905" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180906" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180907" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180908" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180909" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180910" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180911" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180912" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180913" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180914" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180915" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180916" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180917" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180918" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180919" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180920" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180921" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180922" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180923" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180924" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180925" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180926" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180927" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180928" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180929" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20180930" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20181001" UNION ALL
        SELECT "user_pseudo_id", "user_first_touch_timestamp", "event_date" FROM FIREBASE.ANALYTICS_153293282."EVENTS_20181002"
    ) t
    WHERE TO_DATE(TO_TIMESTAMP_NTZ("user_first_touch_timestamp" / 1e6)) >= '2018-07-09'
),
cohorts AS (
    SELECT DISTINCT
        "user_pseudo_id",
        DATE_TRUNC('week', TO_TIMESTAMP_NTZ("user_first_touch_timestamp" / 1e6)) AS "cohort_week_start"
    FROM data
),
user_activity AS (
    SELECT DISTINCT
        "user_pseudo_id",
        DATE_TRUNC('week', TO_DATE("event_date", 'YYYYMMDD')) AS "event_week"
    FROM data
),
user_retention AS (
    SELECT
        ua."user_pseudo_id",
        c."cohort_week_start",
        ua."event_week",
        DATEDIFF('week', c."cohort_week_start", ua."event_week") AS week_number
    FROM user_activity ua
    INNER JOIN cohorts c ON ua."user_pseudo_id" = c."user_pseudo_id"
    WHERE DATEDIFF('week', c."cohort_week_start", ua."event_week") BETWEEN 0 AND 2
),
cohort_size AS (
    SELECT
        "cohort_week_start",
        COUNT(DISTINCT "user_pseudo_id") AS cohort_size
    FROM cohorts
    GROUP BY "cohort_week_start"
)
SELECT
    TO_CHAR(cs."cohort_week_start", 'YYYY-MM-DD') || ' to ' ||
    TO_CHAR(cs."cohort_week_start" + INTERVAL '6 days', 'YYYY-MM-DD') AS "Cohort_Week",
    100 AS "Week0_Retention_Rate",
    ROUND((COUNT(DISTINCT CASE WHEN ur.week_number = 1 THEN ur."user_pseudo_id" END) / cs.cohort_size) * 100, 4) AS "Week1_Retention_Rate",
    ROUND((COUNT(DISTINCT CASE WHEN ur.week_number = 2 THEN ur."user_pseudo_id" END) / cs.cohort_size) * 100, 4) AS "Week2_Retention_Rate"
FROM cohort_size cs
LEFT JOIN user_retention ur ON cs."cohort_week_start" = ur."cohort_week_start"
GROUP BY cs."cohort_week_start", cs.cohort_size
ORDER BY cs."cohort_week_start";