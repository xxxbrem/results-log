WITH all_sessions AS (
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170201"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170202"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170203"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170204"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170205"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170206"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170207"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170208"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170209"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170210"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170211"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170212"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170213"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170214"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170215"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170216"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170217"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170218"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170219"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170220"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170221"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170222"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170223"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170224"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170225"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170226"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170227"
  UNION ALL
  SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170228"
),
sessions AS (
  SELECT
    "fullVisitorId",
    TO_DATE("date", 'YYYYMMDD') AS session_date,
    "visitStartTime",
    "device":deviceCategory::STRING AS "deviceCategory",
    ("totals":transactions)::INTEGER AS "transactions"
  FROM all_sessions
),
first_transactions AS (
  SELECT
    "fullVisitorId",
    MIN(session_date) AS first_transaction_date,
    MIN_BY("deviceCategory", session_date) AS "deviceCategory"
  FROM sessions
  WHERE "transactions" > 0
  GROUP BY "fullVisitorId"
),
first_visits AS (
  SELECT
    "fullVisitorId",
    MIN(session_date) AS first_visit_date
  FROM sessions
  GROUP BY "fullVisitorId"
)
SELECT
  ft."fullVisitorId",
  DATEDIFF('day', fv.first_visit_date, ft.first_transaction_date) AS "days_between",
  ft."deviceCategory"
FROM first_transactions ft
JOIN first_visits fv ON ft."fullVisitorId" = fv."fullVisitorId";