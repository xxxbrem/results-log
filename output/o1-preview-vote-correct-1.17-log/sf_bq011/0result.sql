WITH active_users_last_7_days AS (
    SELECT DISTINCT t."USER_PSEUDO_ID"
    FROM (
        SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20210101"
        UNION ALL
        SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20210102"
        UNION ALL
        SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20210103"
        UNION ALL
        SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20210104"
        UNION ALL
        SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20210105"
        UNION ALL
        SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20210106"
        UNION ALL
        SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20210107"
    ) t,
    LATERAL FLATTEN(input => t."EVENT_PARAMS") f
    WHERE f.value:"key"::STRING = 'engagement_time_msec'
),
active_users_last_2_days AS (
    SELECT DISTINCT t."USER_PSEUDO_ID"
    FROM (
        SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20210106"
        UNION ALL
        SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20210107"
    ) t,
    LATERAL FLATTEN(input => t."EVENT_PARAMS") f
    WHERE f.value:"key"::STRING = 'engagement_time_msec'
)
SELECT COUNT(DISTINCT "USER_PSEUDO_ID") AS "number_of_pseudo_users"
FROM active_users_last_7_days
WHERE "USER_PSEUDO_ID" NOT IN (
    SELECT "USER_PSEUDO_ID" FROM active_users_last_2_days
);