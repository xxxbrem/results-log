WITH all_events AS (
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201201"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201202"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201203"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201204"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201205"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201206"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201207"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201208"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201209"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201210"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201211"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201212"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201213"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201214"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201215"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201216"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201217"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201218"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201219"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201220"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201221"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201222"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201223"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201224"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201225"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201226"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201227"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201228"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201229"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201230"
  UNION ALL SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20201231"
),
purchase_users AS (
  SELECT DISTINCT "USER_PSEUDO_ID"
  FROM all_events
  WHERE "EVENT_NAME" = 'purchase'
),
purchaser_pageviews AS (
  SELECT "USER_PSEUDO_ID", COUNT(*) AS "PAGE_VIEWS"
  FROM all_events
  WHERE "EVENT_NAME" = 'page_view' AND "USER_PSEUDO_ID" IN (SELECT "USER_PSEUDO_ID" FROM purchase_users)
  GROUP BY "USER_PSEUDO_ID"
),
non_purchaser_pageviews AS (
  SELECT "USER_PSEUDO_ID", COUNT(*) AS "PAGE_VIEWS"
  FROM all_events
  WHERE "EVENT_NAME" = 'page_view' AND "USER_PSEUDO_ID" NOT IN (SELECT "USER_PSEUDO_ID" FROM purchase_users)
  GROUP BY "USER_PSEUDO_ID"
)
SELECT ROUND(ABS(
  (SELECT AVG("PAGE_VIEWS") FROM purchaser_pageviews)
  - (SELECT AVG("PAGE_VIEWS") FROM non_purchaser_pageviews)
), 4) AS "difference_in_pageviews";