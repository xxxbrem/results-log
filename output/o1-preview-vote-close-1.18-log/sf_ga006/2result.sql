WITH unioned_events AS (
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201101"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201102"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201103"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201104"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201105"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201106"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201107"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201108"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201109"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201110"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201111"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201112"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201113"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201114"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201115"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201116"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201117"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201118"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201119"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201120"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201121"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201122"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201123"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201124"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201125"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201126"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201127"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201128"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201129"
    UNION ALL
    SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201130"
),
purchase_events AS (
    SELECT
        "USER_PSEUDO_ID" AS "User_ID",
        "EVENT_PARAMS",
        "EVENT_VALUE_IN_USD"
    FROM unioned_events
    WHERE "EVENT_NAME" = 'purchase'
),
events_with_session AS (
    SELECT
        pe."User_ID",
        pe."EVENT_VALUE_IN_USD",
        f.value:"value"::STRING AS "SESSION_ID"
    FROM purchase_events pe,
    LATERAL FLATTEN(input => pe."EVENT_PARAMS") f
    WHERE f.value:"key"::STRING = 'ga_session_id'
),
session_purchases AS (
    SELECT
        "User_ID",
        "SESSION_ID",
        AVG("EVENT_VALUE_IN_USD") AS "Session_Purchase_Value"
    FROM events_with_session
    GROUP BY "User_ID", "SESSION_ID"
),
user_average_purchase AS (
    SELECT
        "User_ID",
        AVG("Session_Purchase_Value") AS "Average_Purchase_Value_Per_Session",
        COUNT(DISTINCT "SESSION_ID") AS "Session_Count"
    FROM session_purchases
    GROUP BY "User_ID"
)
SELECT 
    "User_ID", 
    ROUND("Average_Purchase_Value_Per_Session", 4) AS "Average_Purchase_Value_Per_Session"
FROM user_average_purchase
WHERE "Session_Count" > 1
ORDER BY "User_ID";