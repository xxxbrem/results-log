WITH feb2017_sessions AS (
  SELECT *
  FROM (
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170201"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170202"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170203"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170204"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170205"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170206"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170207"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170208"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170209"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170210"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170211"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170212"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170213"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170214"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170215"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170216"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170217"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170218"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170219"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170220"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170221"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170222"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170223"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170224"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170225"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170226"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170227"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170228"
  )
),
first_visits AS (
  SELECT
    "fullVisitorId",
    MIN(TO_DATE("date", 'YYYYMMDD')) AS "firstVisitDate"
  FROM feb2017_sessions
  GROUP BY "fullVisitorId"
),
first_transactions AS (
  SELECT
    s."fullVisitorId",
    TO_DATE(s."date", 'YYYYMMDD') AS "transactionDate",
    CAST(s."device":"deviceCategory" AS STRING) AS "deviceUsedInTransaction",
    ROW_NUMBER() OVER (
      PARTITION BY s."fullVisitorId" 
      ORDER BY s."visitStartTime"
    ) AS rn
  FROM feb2017_sessions s
  WHERE s."totals":"transactions" > 0
),
first_transactions_filtered AS (
  SELECT
    "fullVisitorId",
    "transactionDate" AS "firstTransactionDate",
    "deviceUsedInTransaction"
  FROM first_transactions
  WHERE rn = 1
),
visit_transaction_diff AS (
  SELECT
    fv."fullVisitorId",
    DATEDIFF('day', fv."firstVisitDate", ft."firstTransactionDate") AS "DaysBetweenFirstVisitAndFirstTransaction",
    ft."deviceUsedInTransaction"
  FROM first_visits fv
  JOIN first_transactions_filtered ft
    ON fv."fullVisitorId" = ft."fullVisitorId"
)
SELECT 
  "fullVisitorId", 
  "DaysBetweenFirstVisitAndFirstTransaction", 
  "deviceUsedInTransaction" AS "DeviceUsedInTransaction"
FROM visit_transaction_diff
ORDER BY "fullVisitorId";