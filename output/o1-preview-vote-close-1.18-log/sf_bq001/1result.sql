WITH all_sessions AS (
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170201"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170202"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170203"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170204"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170205"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170206"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170207"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170208"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170209"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170210"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170211"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170212"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170213"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170214"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170215"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170216"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170217"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170218"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170219"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170220"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170221"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170222"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170223"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170224"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170225"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170226"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170227"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170228"
),
sessions AS (
    SELECT
        "fullVisitorId",
        TRY_TO_DATE("date", 'YYYYMMDD') AS "visitDate",
        "device",
        "hits"
    FROM all_sessions
    WHERE
        TRY_TO_DATE("date", 'YYYYMMDD') BETWEEN '2017-02-01' AND '2017-02-28'
),
first_visits AS (
    SELECT
        "fullVisitorId",
        MIN("visitDate") AS "firstVisitDate"
    FROM sessions
    GROUP BY "fullVisitorId"
),
transactions AS (
    SELECT
        s."fullVisitorId",
        s."visitDate" AS "transactionDate",
        s."device":deviceCategory::STRING AS "deviceUsedInTransaction",
        ROW_NUMBER() OVER (PARTITION BY s."fullVisitorId" ORDER BY s."visitDate") AS rn
    FROM sessions s,
    LATERAL FLATTEN(input => s."hits") f
    WHERE f.value:"transaction":"transactionId" IS NOT NULL
),
first_transactions AS (
    SELECT
        "fullVisitorId",
        "transactionDate" AS "firstTransactionDate",
        "deviceUsedInTransaction"
    FROM transactions
    WHERE rn = 1
)
SELECT
    fv."fullVisitorId" AS "VisitorId",
    DATEDIFF(
        day,
        fv."firstVisitDate",
        ft."firstTransactionDate"
    ) AS "DaysBetweenFirstTransactionAndFirstVisit",
    ft."deviceUsedInTransaction" AS "DeviceUsedInTransaction"
FROM first_visits fv
JOIN first_transactions ft ON fv."fullVisitorId" = ft."fullVisitorId"
ORDER BY "VisitorId";