WITH combined_events AS (
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201101
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201102
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201103
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201104
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201105
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201106
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201107
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201108
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201109
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201110
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201111
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201112
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201113
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201114
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201115
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201116
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201117
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201118
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201119
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201120
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201121
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201122
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201123
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201124
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201125
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201126
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201127
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201128
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201129
    UNION ALL
    SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20201130
),
buyers_per_day AS (
    SELECT DISTINCT "EVENT_DATE", "USER_PSEUDO_ID"
    FROM combined_events
    WHERE "EVENT_NAME" = 'purchase'
)
SELECT
    TRY_TO_DATE(sub."EVENT_DATE", 'YYYYMMDD') AS "Date",
    ROUND(AVG(sub.page_views_per_buyer), 4) AS "Average_Page_Views_per_Buyer",
    SUM(sub.page_views_per_buyer) AS "Total_Page_Views_among_Buyers"
FROM (
    SELECT
        t."EVENT_DATE",
        t."USER_PSEUDO_ID",
        COUNT(*) AS page_views_per_buyer
    FROM combined_events t
    INNER JOIN buyers_per_day b
        ON t."USER_PSEUDO_ID" = b."USER_PSEUDO_ID" AND t."EVENT_DATE" = b."EVENT_DATE"
    WHERE t."EVENT_NAME" = 'page_view'
    GROUP BY t."EVENT_DATE", t."USER_PSEUDO_ID"
) sub
GROUP BY "Date"
ORDER BY "Date";