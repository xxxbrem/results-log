WITH november_events AS (
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201101"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201102"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201103"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201104"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201105"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201106"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201107"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201108"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201109"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201110"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201111"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201112"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201113"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201114"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201115"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201116"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201117"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201118"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201119"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201120"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201121"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201122"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201123"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201124"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201125"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201126"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201127"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201128"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201129"
  UNION ALL
  SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201130"
),
buyers_by_day AS (
  SELECT DISTINCT "EVENT_DATE", "USER_PSEUDO_ID"
  FROM november_events
  WHERE "EVENT_NAME" = 'purchase'
),
page_views_by_buyer AS (
  SELECT "EVENT_DATE", "USER_PSEUDO_ID", COUNT(*) AS page_views
  FROM november_events
  WHERE "EVENT_NAME" = 'page_view'
  GROUP BY "EVENT_DATE", "USER_PSEUDO_ID"
),
page_views_of_buyers AS (
  SELECT pv."EVENT_DATE", pv."USER_PSEUDO_ID", pv.page_views
  FROM page_views_by_buyer pv
  JOIN buyers_by_day b
    ON pv."EVENT_DATE" = b."EVENT_DATE" AND pv."USER_PSEUDO_ID" = b."USER_PSEUDO_ID"
)
SELECT TO_DATE("EVENT_DATE", 'YYYYMMDD') AS "Day",
       ROUND(AVG(page_views), 4) AS "Average_page_views_per_buyer",
       SUM(page_views) AS "Total_page_views"
FROM page_views_of_buyers
GROUP BY "EVENT_DATE"
ORDER BY "EVENT_DATE";