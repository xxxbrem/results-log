WITH AllEvents AS (
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210101
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210102
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210103
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210104
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210105
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210106
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210107
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210108
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210109
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210110
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210111
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210112
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210113
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210114
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210115
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210116
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210117
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210118
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210119
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210120
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210121
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210122
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210123
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210124
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210125
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210126
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210127
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210128
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210129
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210130
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE.EVENTS_20210131
),
PageViews AS (
  SELECT
    t."USER_PSEUDO_ID",
    f.value:"value":"string_value"::STRING AS "page_title"
  FROM AllEvents t,
    LATERAL FLATTEN(INPUT => t."EVENT_PARAMS") f
  WHERE t."EVENT_NAME" = 'page_view'
    AND f.value:"key"::STRING = 'page_title'
)
SELECT COUNT(DISTINCT p."USER_PSEUDO_ID") AS "Distinct_user_count"
FROM PageViews p
WHERE p."page_title" = (
  SELECT "page_title"
  FROM PageViews
  GROUP BY "page_title"
  ORDER BY COUNT(*) DESC NULLS LAST
  LIMIT 1
);