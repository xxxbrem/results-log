WITH sessions_feb AS (
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170201"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170202"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170203"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170204"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170205"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170206"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170207"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170208"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170209"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170210"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170211"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170212"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170213"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170214"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170215"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170216"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170217"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170218"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170219"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170220"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170221"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170222"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170223"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170224"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170225"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170226"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170227"
    UNION ALL
    SELECT *
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170228"
),
first_transactions AS (
    SELECT
        t."fullVisitorId",
        t."date" AS "transactionDate",
        t."device":"deviceCategory"::STRING AS "deviceType",
        t."visitStartTime",
        ROW_NUMBER() OVER (PARTITION BY t."fullVisitorId" ORDER BY t."visitStartTime") AS rn
    FROM sessions_feb t,
    LATERAL FLATTEN(input => t."hits") h
    WHERE h.value:"transaction":"transactionId" IS NOT NULL
),
first_visits AS (
    SELECT
        t."fullVisitorId",
        t."date" AS "visitDate",
        t."visitStartTime",
        ROW_NUMBER() OVER (PARTITION BY t."fullVisitorId" ORDER BY t."visitStartTime") AS rn
    FROM sessions_feb t
)
SELECT
    ft."fullVisitorId" AS "visitorId",
    DATEDIFF('day', TO_DATE(fv."visitDate", 'YYYYMMDD'), TO_DATE(ft."transactionDate", 'YYYYMMDD')) AS "days_elapsed_since_first_visit",
    ft."deviceType"
FROM
    (SELECT * FROM first_transactions WHERE rn = 1) ft
JOIN
    (SELECT * FROM first_visits WHERE rn = 1) fv
ON ft."fullVisitorId" = fv."fullVisitorId"
ORDER BY ft."fullVisitorId";