WITH combined_sessions AS (
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170401" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170408" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170409" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170414" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170416" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170418" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170419" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170421" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170422" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170423" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170424" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170425" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170426" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170427" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170428" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170429" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170430" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170505" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170506" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170512" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170514" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170520" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170524" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170526" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170602" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170604" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170610" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170616" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170623" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170625" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170626" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170629" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170703" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170704" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170707" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170709" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170710" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170711" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170713" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170716" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170717" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170718" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170721" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170722" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170723" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170724" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170725" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170726" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170727" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170728" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170729" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170730" UNION ALL
    SELECT "fullVisitorId", "visitId", "date", "totals", "hits"
    FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170731"
),
session_product_data AS (
    SELECT
        s."fullVisitorId",
        s."visitId",
        s."date",
        s."totals":"pageviews"::NUMBER AS "pageviews",
        s."totals":"transactions"::NUMBER AS "transactions",
        MAX(CASE WHEN p.value:"productRevenue" IS NOT NULL THEN 1 ELSE 0 END) AS "has_product_revenue"
    FROM
        combined_sessions s,
        LATERAL FLATTEN(input => s."hits", outer => TRUE) h,
        LATERAL FLATTEN(input => h.value:"product", outer => TRUE) p
    GROUP BY
        s."fullVisitorId",
        s."visitId",
        s."date",
        s."totals":"pageviews"::NUMBER,
        s."totals":"transactions"::NUMBER
),
classified_sessions AS (
    SELECT
        "fullVisitorId",
        "visitId",
        "date",
        "pageviews",
        "transactions",
        CASE
            WHEN "transactions" >= 1 AND "has_product_revenue" = 1 THEN 'purchase'
            WHEN "transactions" IS NULL AND "has_product_revenue" = 0 THEN 'non-purchase'
            ELSE NULL
        END AS "Group"
    FROM session_product_data
    WHERE ("transactions" >= 1 AND "has_product_revenue" = 1) OR ("transactions" IS NULL AND "has_product_revenue" = 0)
),
per_visitor AS (
    SELECT
        "fullVisitorId",
        TO_CHAR(TO_DATE("date", 'YYYYMMDD'), 'YYYY-MM') AS "Month",
        "Group",
        "pageviews"
    FROM classified_sessions
),
aggregate_per_visitor AS (
    SELECT
        "Month",
        "Group",
        "fullVisitorId",
        SUM("pageviews") AS "total_pageviews"
    FROM per_visitor
    GROUP BY "Month", "Group", "fullVisitorId"
),
average_pageviews AS (
    SELECT
        "Month",
        "Group",
        ROUND(AVG("total_pageviews"), 4) AS "Average_Pageviews_per_visitor"
    FROM aggregate_per_visitor
    GROUP BY "Month", "Group"
)
SELECT
    "Month",
    "Group",
    "Average_Pageviews_per_visitor"
FROM average_pageviews
WHERE
    "Month" BETWEEN '2017-04' AND '2017-07'
ORDER BY
    "Month",
    "Group";