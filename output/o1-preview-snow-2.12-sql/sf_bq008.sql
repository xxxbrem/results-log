WITH sessions AS (
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170101"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170102"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170103"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170104"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170105"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170106"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170107"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170108"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170109"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170110"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170111"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170112"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170113"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170114"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170115"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170116"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170117"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170118"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170119"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170120"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170121"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170122"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170123"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170124"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170125"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170126"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170127"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170128"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170129"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170130"
    UNION ALL
    SELECT * FROM "GA360"."GOOGLE_ANALYTICS_SAMPLE"."GA_SESSIONS_20170131"
),
home_hits AS (
    SELECT
        t."fullVisitorId",
        t."visitId",
        h.value:hitNumber::INTEGER AS "hitNumber",
        h.value:time::INTEGER AS "hitTime",
        h.value:page:pagePath::STRING AS "currentPage",
        LEAD(h.value:page:pagePath::STRING) OVER (
            PARTITION BY t."fullVisitorId", t."visitId" ORDER BY h.value:hitNumber::INTEGER
        ) AS "nextPage",
        LEAD(h.value:time::INTEGER) OVER (
            PARTITION BY t."fullVisitorId", t."visitId" ORDER BY h.value:hitNumber::INTEGER
        ) AS "nextHitTime"
    FROM sessions AS t,
         LATERAL FLATTEN(input => t."hits") AS h
    WHERE t."trafficSource":campaign::STRING ILIKE '%Data Share%'
)
SELECT
    n."Next_Page",
    m."Max_Time_On_Home_Page"
FROM
    (
        SELECT "nextPage" AS "Next_Page", COUNT(*) AS "cnt"
        FROM home_hits
        WHERE "currentPage" LIKE '/home%'
          AND "nextPage" IS NOT NULL
        GROUP BY "nextPage"
        ORDER BY "cnt" DESC NULLS LAST
        LIMIT 1
    ) AS n
CROSS JOIN
    (
        SELECT CAST(MAX(("nextHitTime" - "hitTime") / 1000) AS INTEGER) AS "Max_Time_On_Home_Page"
        FROM home_hits
        WHERE "currentPage" LIKE '/home%'
          AND "nextPage" IS NOT NULL
    ) AS m;