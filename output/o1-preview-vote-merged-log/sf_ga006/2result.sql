WITH all_events AS (
    SELECT * FROM (
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201101"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201102"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201103"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201104"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201105"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201106"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201107"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201108"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201109"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201110"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201111"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201112"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201113"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201114"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201115"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201116"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201117"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201118"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201119"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201120"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201121"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201122"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201123"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201124"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201125"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201126"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201127"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201128"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201129"
        UNION ALL
        SELECT * FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201130"
    )
),
purchase_events AS (
    SELECT
        COALESCE("USER_ID", "USER_PSEUDO_ID") AS "User_ID",
        "EVENT_DATE" AS "Session_ID",
        "EVENT_VALUE_IN_USD"
    FROM
        all_events
    WHERE
        "EVENT_NAME" = 'purchase'
        AND COALESCE("USER_ID", "USER_PSEUDO_ID") IS NOT NULL
        AND "EVENT_VALUE_IN_USD" IS NOT NULL
),
user_sessions AS (
    SELECT
        "User_ID",
        "Session_ID",
        AVG("EVENT_VALUE_IN_USD") AS "Average_Purchase_Value_USD"
    FROM
        purchase_events
    GROUP BY
        "User_ID",
        "Session_ID"
),
users_with_multiple_sessions AS (
    SELECT
        "User_ID"
    FROM
        user_sessions
    GROUP BY
        "User_ID"
    HAVING
        COUNT(*) > 1
)
SELECT
    us."User_ID",
    us."Session_ID",
    ROUND(us."Average_Purchase_Value_USD", 4) AS "Average_Purchase_Value_USD"
FROM
    user_sessions us
JOIN
    users_with_multiple_sessions ums ON us."User_ID" = ums."User_ID"
ORDER BY
    us."User_ID",
    us."Session_ID";