WITH sessions AS (
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170701
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170702
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170703
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170704
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170705
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170706
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170707
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170708
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170709
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170710
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170711
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170712
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170713
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170714
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170715
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170716
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170717
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170718
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170719
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170720
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170721
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170722
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170723
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170724
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170725
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170726
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170727
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170728
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170729
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170730
   UNION ALL
   SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.GA_SESSIONS_20170731
),
buyers AS (
   SELECT DISTINCT t."fullVisitorId"
   FROM sessions t,
        LATERAL FLATTEN(input => t."hits") h1,
        LATERAL FLATTEN(input => h1.value:"product") f1
   WHERE f1.value:"v2ProductName"::STRING = 'YouTube Men''s Vintage Henley'
     AND h1.value:"eCommerceAction":"action_type"::INTEGER = 6
)
SELECT f.value:"v2ProductName"::STRING AS "product_name",
       ROUND(SUM(f.value:"productRevenue"::NUMBER(38,4))/1000000.0, 4) AS "total_sales"
FROM sessions t,
     LATERAL FLATTEN(input => t."hits") h,
     LATERAL FLATTEN(input => h.value:"product") f
WHERE t."fullVisitorId" IN (SELECT "fullVisitorId" FROM buyers)
  AND f.value:"v2ProductName"::STRING != 'YouTube Men''s Vintage Henley'
  AND h.value:"eCommerceAction":"action_type"::INTEGER = 6
GROUP BY "product_name"
ORDER BY "total_sales" DESC NULLS LAST
LIMIT 1;