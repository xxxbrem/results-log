WITH last5days_events AS (
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20210101"
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20210102"
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20210103"
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20210104"
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20210105"
),
active_users_last5days AS (
  SELECT DISTINCT "USER_PSEUDO_ID"
  FROM last5days_events,
       LATERAL FLATTEN(input => last5days_events."EVENT_PARAMS") AS flattened_params
  WHERE flattened_params.VALUE:"key"::STRING = 'engagement_time_msec'
),
last2days_events AS (
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20210106"
  UNION ALL
  SELECT * FROM GA4.GA4_OBFUSCATED_SAMPLE_ECOMMERCE."EVENTS_20210107"
),
active_users_last2days AS (
  SELECT DISTINCT "USER_PSEUDO_ID"
  FROM last2days_events,
       LATERAL FLATTEN(input => last2days_events."EVENT_PARAMS") AS flattened_params
  WHERE flattened_params.VALUE:"key"::STRING = 'engagement_time_msec'
)
SELECT COUNT(DISTINCT "USER_PSEUDO_ID") AS "number_of_pseudo_users"
FROM active_users_last5days
WHERE "USER_PSEUDO_ID" NOT IN (
  SELECT "USER_PSEUDO_ID" FROM active_users_last2days
);