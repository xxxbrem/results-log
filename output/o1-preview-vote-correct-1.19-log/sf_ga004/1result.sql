WITH all_events AS (
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201201" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201202" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201203" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201204" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201205" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201206" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201207" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201208" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201209" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201210" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201211" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201212" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201213" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201214" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201215" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201216" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201217" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201218" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201219" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201220" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201221" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201222" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201223" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201224" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201225" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201226" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201227" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201228" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201229" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201230" UNION ALL
  SELECT "USER_PSEUDO_ID", "EVENT_NAME" FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201231"
),
purchasers AS (
  SELECT DISTINCT "USER_PSEUDO_ID"
  FROM all_events
  WHERE "EVENT_NAME" = 'purchase'
),
pageviews_per_user AS (
  SELECT "USER_PSEUDO_ID", COUNT(*) AS "PAGEVIEW_COUNT"
  FROM all_events
  WHERE "EVENT_NAME" = 'page_view'
  GROUP BY "USER_PSEUDO_ID"
),
users_with_flags AS (
  SELECT u."USER_PSEUDO_ID",
         COALESCE(pv."PAGEVIEW_COUNT", 0) AS "PAGEVIEW_COUNT",
         CASE WHEN p."USER_PSEUDO_ID" IS NOT NULL THEN 1 ELSE 0 END AS "IS_PURCHASER"
  FROM (SELECT DISTINCT "USER_PSEUDO_ID" FROM all_events) u
  LEFT JOIN purchasers p ON u."USER_PSEUDO_ID" = p."USER_PSEUDO_ID"
  LEFT JOIN pageviews_per_user pv ON u."USER_PSEUDO_ID" = pv."USER_PSEUDO_ID"
)
SELECT
  ROUND(
    AVG(CASE WHEN "IS_PURCHASER" = 1 THEN "PAGEVIEW_COUNT" ELSE NULL END) -
    AVG(CASE WHEN "IS_PURCHASER" = 0 THEN "PAGEVIEW_COUNT" ELSE NULL END),
    4
  ) AS "average_difference_in_pageviews"
FROM users_with_flags;